// ============================================================
// OSE Magic & Turn Undead — spell slots and turning mechanics
//
// Spell slots: 2D table lookup (SpellProgression × level → list<int>).
// 9 progression categories × up to 14 levels.
// Each entry is a 6-element list: slots for spell levels 1–6.
//
// Turn undead: algorithmic derive based on cleric_level − undead_rank.
// Follows the diagonal pattern from OSE Reference Booklet p18.
//
// Reference: oag/src/rules/spell.rs (spell progressions),
//            oag/src/rules/turn.rs (turn undead formula).
// ============================================================

use "OSE"

system "OSE Magic" {

    // ========================================================
    //  SPELL SLOT TABLE
    //
    //  2D lookup: (SpellProgression, level) → list<int>
    //  Returns a 6-element list of spell slots for levels 1–6.
    //  A 0 means no spells of that level available.
    //
    //  OSE Reference Booklet p16-17.
    // ========================================================

    table spell_slots(progression: SpellProgression, level: int) -> list<int> {

        // --- NonCaster (Fighter, Thief, etc.) ---
        // No spells at any level.
        [NonCaster, _] => [0, 0, 0, 0, 0, 0],

        // --- Bard: druid spell list, up to 4th level spells ---
        [Bard, 1]       => [0, 0, 0, 0, 0, 0],
        [Bard, 2]       => [1, 0, 0, 0, 0, 0],
        [Bard, 3]       => [2, 0, 0, 0, 0, 0],
        [Bard, 4]       => [3, 0, 0, 0, 0, 0],
        [Bard, 5]       => [3, 1, 0, 0, 0, 0],
        [Bard, 6]       => [3, 2, 0, 0, 0, 0],
        [Bard, 7]       => [3, 3, 0, 0, 0, 0],
        [Bard, 8]       => [3, 3, 1, 0, 0, 0],
        [Bard, 9]       => [3, 3, 2, 0, 0, 0],
        [Bard, 10]      => [3, 3, 3, 0, 0, 0],
        [Bard, 11]      => [3, 3, 3, 1, 0, 0],
        [Bard, 12]      => [3, 3, 3, 2, 0, 0],
        [Bard, 13]      => [3, 3, 3, 3, 0, 0],
        [Bard, 14]      => [4, 4, 3, 3, 0, 0],

        // --- Cleric: cleric spell list, up to 5th level spells ---
        [Cleric, 1]     => [0, 0, 0, 0, 0, 0],
        [Cleric, 2]     => [1, 0, 0, 0, 0, 0],
        [Cleric, 3]     => [2, 0, 0, 0, 0, 0],
        [Cleric, 4]     => [2, 1, 0, 0, 0, 0],
        [Cleric, 5]     => [2, 2, 0, 0, 0, 0],
        [Cleric, 6]     => [2, 2, 1, 1, 0, 0],
        [Cleric, 7]     => [2, 2, 2, 1, 1, 0],
        [Cleric, 8]     => [3, 3, 2, 2, 1, 0],
        [Cleric, 9]     => [3, 3, 3, 2, 2, 0],
        [Cleric, 10]    => [4, 4, 3, 3, 2, 0],
        [Cleric, 11]    => [4, 4, 4, 3, 3, 0],
        [Cleric, 12]    => [5, 5, 4, 4, 3, 0],
        [Cleric, 13]    => [5, 5, 5, 4, 4, 0],
        [Cleric, 14]    => [6, 5, 5, 5, 4, 0],

        // --- Drow: arcane+divine spell list, up to 5th level spells ---
        [Drow, 1]       => [1, 0, 0, 0, 0, 0],
        [Drow, 2]       => [2, 0, 0, 0, 0, 0],
        [Drow, 3]       => [2, 1, 0, 0, 0, 0],
        [Drow, 4]       => [2, 2, 0, 0, 0, 0],
        [Drow, 5]       => [2, 2, 1, 0, 0, 0],
        [Drow, 6]       => [2, 2, 2, 1, 0, 0],
        [Drow, 7]       => [3, 3, 2, 2, 1, 0],
        [Drow, 8]       => [3, 3, 3, 2, 2, 0],
        [Drow, 9]       => [4, 4, 3, 3, 2, 0],
        [Drow, 10]      => [4, 4, 4, 3, 3, 0],

        // --- Druid: druid spell list, up to 5th level spells ---
        [Druid, 1]      => [1, 0, 0, 0, 0, 0],
        [Druid, 2]      => [2, 0, 0, 0, 0, 0],
        [Druid, 3]      => [2, 1, 0, 0, 0, 0],
        [Druid, 4]      => [2, 2, 0, 0, 0, 0],
        [Druid, 5]      => [2, 2, 1, 1, 0, 0],
        [Druid, 6]      => [2, 2, 2, 1, 1, 0],
        [Druid, 7]      => [3, 3, 2, 2, 1, 0],
        [Druid, 8]      => [3, 3, 3, 2, 2, 0],
        [Druid, 9]      => [4, 4, 3, 3, 2, 0],
        [Druid, 10]     => [4, 4, 4, 3, 3, 0],
        [Druid, 11]     => [5, 5, 4, 4, 3, 0],
        [Druid, 12]     => [5, 5, 5, 4, 4, 0],
        [Druid, 13]     => [6, 5, 5, 5, 4, 0],
        [Druid, 14]     => [6, 6, 5, 5, 5, 0],

        // --- Arcane Full Caster (Elf, Gnome, Illusionist, Magic-User) ---
        // Up to 6th level spells.
        [ArcaneFull, 1]  => [1, 0, 0, 0, 0, 0],
        [ArcaneFull, 2]  => [2, 0, 0, 0, 0, 0],
        [ArcaneFull, 3]  => [2, 1, 0, 0, 0, 0],
        [ArcaneFull, 4]  => [2, 2, 0, 0, 0, 0],
        [ArcaneFull, 5]  => [2, 2, 1, 0, 0, 0],
        [ArcaneFull, 6]  => [2, 2, 2, 0, 0, 0],
        [ArcaneFull, 7]  => [3, 2, 2, 1, 0, 0],
        [ArcaneFull, 8]  => [3, 3, 2, 2, 0, 0],
        [ArcaneFull, 9]  => [3, 3, 3, 2, 1, 0],
        [ArcaneFull, 10] => [3, 3, 3, 3, 2, 0],
        [ArcaneFull, 11] => [4, 3, 3, 3, 2, 1],
        [ArcaneFull, 12] => [4, 4, 3, 3, 3, 2],
        [ArcaneFull, 13] => [4, 4, 4, 3, 3, 3],
        [ArcaneFull, 14] => [4, 4, 4, 4, 3, 3],

        // --- Half-Elf: magic-user spell list, up to 4th level spells ---
        [HalfElf, 1]   => [0, 0, 0, 0, 0, 0],
        [HalfElf, 2]   => [1, 0, 0, 0, 0, 0],
        [HalfElf, 3]   => [2, 0, 0, 0, 0, 0],
        [HalfElf, 4]   => [2, 0, 0, 0, 0, 0],
        [HalfElf, 5]   => [2, 1, 0, 0, 0, 0],
        [HalfElf, 6]   => [2, 2, 0, 0, 0, 0],
        [HalfElf, 7]   => [2, 2, 0, 0, 0, 0],
        [HalfElf, 8]   => [2, 2, 1, 0, 0, 0],
        [HalfElf, 9]   => [3, 2, 1, 0, 0, 0],
        [HalfElf, 10]  => [3, 2, 2, 0, 0, 0],
        [HalfElf, 11]  => [3, 2, 2, 1, 0, 0],
        [HalfElf, 12]  => [3, 3, 2, 1, 0, 0],

        // --- Paladin: cleric spell list, up to 3rd level spells ---
        // No spells until level 9.
        [Paladin, 1..=8]  => [0, 0, 0, 0, 0, 0],
        [Paladin, 9]      => [1, 0, 0, 0, 0, 0],
        [Paladin, 10]     => [2, 0, 0, 0, 0, 0],
        [Paladin, 11]     => [2, 1, 0, 0, 0, 0],
        [Paladin, 12]     => [2, 2, 0, 0, 0, 0],
        [Paladin, 13]     => [2, 2, 1, 0, 0, 0],
        [Paladin, 14]     => [3, 2, 1, 0, 0, 0],

        // --- Ranger: druid spell list, up to 3rd level spells ---
        // No spells until level 8.
        [Ranger, 1..=7]   => [0, 0, 0, 0, 0, 0],
        [Ranger, 8]       => [1, 0, 0, 0, 0, 0],
        [Ranger, 9]       => [2, 0, 0, 0, 0, 0],
        [Ranger, 10]      => [2, 1, 0, 0, 0, 0],
        [Ranger, 11]      => [2, 2, 0, 0, 0, 0],
        [Ranger, 12]      => [2, 2, 1, 0, 0, 0],
        [Ranger, 13]      => [3, 2, 1, 0, 0, 0],
        [Ranger, 14]      => [3, 2, 2, 0, 0, 0]
    }


    // ========================================================
    //  SPELL SLOT DERIVES
    // ========================================================

    // Check if a class has any spell slots at a given level.
    derive can_cast(progression: SpellProgression, level: int) -> bool {
        let slots = spell_slots(progression, level)
        slots[0] > 0 || slots[1] > 0 || slots[2] > 0 ||
        slots[3] > 0 || slots[4] > 0 || slots[5] > 0
    }

    // Total number of spell slots across all spell levels.
    derive total_spell_slots(progression: SpellProgression, level: int) -> int {
        let slots = spell_slots(progression, level)
        slots[0] + slots[1] + slots[2] + slots[3] + slots[4] + slots[5]
    }


    // ========================================================
    //  TURN UNDEAD
    //
    //  Algorithmic: result depends on (cleric_level − undead_rank).
    //  Follows the diagonal pattern from OSE Reference Booklet p18.
    //
    //  Undead ranks (1–9):
    //    1=Skeleton  2=Zombie  3=Ghoul   4=Wight   5=Wraith
    //    6=Mummy     7=Spectre 8=Vampire 9=Infernal (9+ HD)
    //
    //  diff ≤ -3: Impossible
    //  diff = -2: Roll(11) — need 11+ on 2d6
    //  diff = -1: Roll(9)  — need 9+ on 2d6
    //  diff =  0: Roll(7)  — need 7+ on 2d6
    //  diff 1–2:  Turned   — automatic turn
    //  diff ≥ 3:  Destroyed — automatic destroy
    // ========================================================

    // Convert undead Hit Dice to a turn undead rank (1–9).
    // HD 1–8 map directly; HD 9+ all map to rank 9.
    derive undead_rank_from_hd(hd: int) -> int {
        match {
            hd < 1 => 1,
            hd > 9 => 9,
            _      => hd
        }
    }

    // Look up the turn undead result for a given cleric level and undead rank.
    derive turn_undead_result(cleric_level: int, undead_rank: int) -> TurnResult {
        let rank = match {
            undead_rank < 1 => 1,
            undead_rank > 9 => 9,
            _               => undead_rank
        }
        let diff = cleric_level - rank
        match {
            diff <= -3 => TurnResult.Impossible,
            diff == -2 => TurnResult.Roll(11),
            diff == -1 => TurnResult.Roll(9),
            diff == 0  => TurnResult.Roll(7),
            diff <= 2  => TurnResult.Turned,
            _          => TurnResult.Destroyed
        }
    }
}
